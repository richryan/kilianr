---
title: "Structural VAR Models Using Recursive Identification"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Structural VAR Models Using Recursive Identification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib  
link-citations: TRUE
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

devtools::build_rmd("vignettes/structural-VAR-using-recursive-identification.Rmd")

## Introduction

Here are some useful functions that can be used to analyze 
structural vector autoregressive models or
structural VAR models.
In particular,
the functions go through estimating a recursively identified model.
A prime example of this method is used by Lutz Kilian in

> Kilian, Lutz. 2009. "Not All Oil Price Shocks Are Alike: Disentangling Demand and Supply Shocks in the Crude Oil Market." American Economic Review, 99 (3): 1053–69. DOI: 10.1257/aer.99.3.1053

Functions in the package kilianr can:

1. Estimate a VAR model by unrestricted least squares
1. Identify models using Cholesky decompositions
1. Compute confidence sets for these estimators

Good background reading includes

- Kilian, Lutz, and Helmut Lütkepohl. *Structural Vector Autoregressive Analysis*. Cambridge: Cambridge University Press, 2017.
- Helmut Lütkepohl. *New Introduction to Multiple Time Series Analysis*. Berlin: Springer, 2005.


The package closely follows the analysis in
[*Structural Vector Autoregressive Analysis*](https://www.cambridge.org/core/books/structural-vector-autoregressive-analysis/DAF4217439EA585D10902D58A8849E06).

## Least-squares estimation

Interest is in $K$ time-series variables.
For example, quarterly US data on
the rate of price inflation,
the unemployment rate, and
the interest rate---in which case, $K=3$ [@stock_watson_2001].^[The system is analyzed by Stock and Watson. See: Stock, James, H., and Mark W. Watson. 2001. "Vector Autoregressions." Journal of Economic Perspectives, 15 (4): 101--115. DOI: 10.1257/jep.15.4.101.]
The time series can be represented as
$$
y_{t}=\left(y_{1t},\dots,y_{Kt}\right)^{\prime}.
$$
The data generating process is posited to follow a linear VAR process of order $p$,
often written as VAR($p$).
Which means the statistical model for $y_t$ can be written as 
$$
y_{t}=\nu+A_{1}y_{t-1}+\cdots+A_{p}y_{t-p}+u_{t},
$$
where 

- the vector $\nu=\left(\nu_{1},\dots,\nu_{K}\right)^{\prime}$ is a $\left(K\times1\right)$ vector of intercept terms,
- the $A_i$, $i=1,\dots,p$, are $K \times K$ parameter matricies, and
- the vector $u_t = \left( u_{1t},\dots,u_{Kt} \right)^{\prime}$ is a $K$-dimensional zero-mean white-noise process; that is, $u_t$ is assumed to be iid white noise with nonsingular covariance matrix $\Sigma_u$, $u_t \overset{\text{iid}}{\sim} \left( 0, \Sigma_u \right)$.

Under some common regularity assumptions discussed by Kilian and Lütkepohl,
the model can be estimated by least squares efficiently.

### Empirical demonstration of LS estimation

The functions in kilianr can easily produce LS estimates.
This example comes from section 2.3 of [*Structural Vector Autoregressive Analysis*](https://www.cambridge.org/core/books/structural-vector-autoregressive-analysis/DAF4217439EA585D10902D58A8849E06).

The empirical demonstration uses quarterly US data on
real GNP growth,
the federal funds rate, and
inflation measured using the GNP deflator.
These data are included in `kilianLutkepohlCh02Macro`.

```{r}
library(dplyr)
library(tidyr)
library(kilianr)
library(ggplot2)
library(patchwork)

plt_rgnp <- ggplot(data = kilianLutkepohlCh02Macro) +
  geom_line(mapping = aes(x = date, y = drgnp)) +
  labs(x = "", y = "", title= "Real GNP growth") +
  scale_x_date(expand = c(0, 0))  

plt_ffr <- ggplot(data = kilianLutkepohlCh02Macro) +
  geom_line(mapping = aes(x = date, y = irate)) +
  labs(x = "", y = "", title= "Federal funds rate") +
  scale_x_date(expand = c(0, 0))  

plt_infl <- ggplot(data = kilianLutkepohlCh02Macro) +
  geom_line(mapping = aes(x = date, y = infl)) +
  labs(x = "", y = "", title= "GNP deflator inflation") +
  scale_x_date(expand = c(0, 0))  

# Using notation from the patchwork package to combine figures
plt_rgnp / plt_ffr / plt_infl
```

The VAR($4$) model for $y_t = \left( \Delta \text{GNP}_t, \text{interest rate}_t, \Delta \text{price}_t \right)$ can be estimated by LS using the code show below.
The function `olsvarc` includes a constant.
```{r setup}
y <- kilianLutkepohlCh02Macro |> select(drgnp, irate, infl)
sol <- olsvarc(y, p = 4)
```

The code can be checked against the estimates show on page 33 of
[*Structural Vector Autoregressive Analysis*](https://www.cambridge.org/core/books/structural-vector-autoregressive-analysis/DAF4217439EA585D10902D58A8849E06).
The following block of code prints out the LS estimates.
Here are the LS estimates, $\hat{\nu}$:
```{r}
print(round(sol$Vhat, 4))
```

And the LS estimates, $\hat{A}_1, \dots, \hat{A}_4$:
```{r}
KK <- 3
pp <- 4
for (i in 1:pp) {
  # The A_i hats have indices 1--K, (K+1)--2K, (2K+1)--3K, ...
  # 1-3, 4-6, 7-9
  print(paste0("A_", i, ": "))
  print(round(sol$Ahat[, ((i - 1) * KK + 1):(i * KK)], 4))
}
```

A consistent estimator of $\Sigma_u$ under the above assumptions, $\widehat{\Sigma}_u$,
is expressed in equation (2.3.4), page 31, of [*Structural Vector Autoregressive Analysis*](https://www.cambridge.org/core/books/structural-vector-autoregressive-analysis/DAF4217439EA585D10902D58A8849E06).
The estimate is
```{r}
print(round(sol$SIGMAhat, 4))
```

These values agree with those found on page 34 for this example.

## Using short-run identification restrictions to recursively identify models: Cholesky decomposition

A structural VAR identifies correlations among variables using economic theory.
The identifying assumptions allow the correlations to be interpreted causally.

The $K$-dimensional structural VAR($p$) model is
$$
B_{0}y_{t}=B_{1}y_{t-1}+\cdots+B_{p}y_{t-p}+w_{t},
$$
where $w_t \sim \left( 0, \Sigma_w \right)$ are the structural errors.
The structural errors have a diagonal covariance matrix $\Sigma_w$ and are serially uncorrelated. 
The corresponding reduced form is
$$
\begin{align*}
y_{t}	&=\underbrace{B_{0}^{-1}B_{1}}_{A_{1}}y_{t-1}+\cdots+\underbrace{B_{0}^{-1}B_{p}}_{A_{p}}y_{t-p}+\underbrace{B_{0}^{-1}w_{t}}_{u_{t}} \\
	&=A_{1}y_{t-1}+\cdots+A_{p}y_{t-p}+u_{t}.
\end{align*}
$$
Going from the reduced-form to structural representation requires knowledge of $B_0^{-1}$.
The structural representation offers a causal interpretation of the correlations uncovered by the model.

Recursive identificaiton is one of the most straightforward ways to identify a VAR model.
This method decomposes $\widehat{\Sigma}_u$ using the Cholesky decomposition.
Kilian and Lütkepohl discuss this approach in chapter 9 of [*Structural Vector Autoregressive Analysis*](https://www.cambridge.org/core/books/structural-vector-autoregressive-analysis/DAF4217439EA585D10902D58A8849E06).
This example comes from that chapter discussed around figure 9.1,
which is found on page 244.

To confirm the reduced-form parameter estimates,
the following code shows LS estimates 

```{r}
var_order_macro_oil <- c("drpoil", "infl", "drgdp")
y_macro_oil <- kilianLutkepohlCh09Figure9_1 |> select(all_of(var_order_macro_oil))
sol_macro_oil <- olsvarc(y_macro_oil, p = 4)

KK <- 3
pp <- 4
for (i in 1:pp) {
  # The A_i hats have indices 1--K, (K+1)--2K, (2K+1)--3K, ...
  # 1-3, 4-6, 7-9
  print(paste0("A_", i, ": "))
  print(round(sol_macro_oil$Ahat[, ((i - 1) * KK + 1):(i * KK)], 4))
}
```
The residual variance--covariance matrix $\widehat{\Sigma}_u$ is
```{r}
print(round(sol_macro_oil$SIGMAhat, 4))
```

These estimates agree with those reported on page 243.

The estimated $\text{chol} \left( \widehat{\Sigma}_u \right)$ is

```{r}
B0inv <- t(chol(sol_macro_oil$SIGMAhat))
print(round(B0inv, 4))
```
The decomposition is such that $\text{chol} \left( \widehat{\Sigma}_u \right) = \widehat{B}_0^{-1}$ and
$\left( \widehat{B}_0^{-1} \right) \left( \widehat{B}_0^{-1} \right)^{\prime} = \widehat{\Sigma}_u$.

This agrees with the numbers reported on page 244.

The next chunk of code computes the impulse response functions.
The function `irfvar()` returns the impulse responses at various horizons.

```{r}
horizon <- 12
irf_macro_oil <- irfvar(sol_macro_oil$Ahat, B0inv, p = sol_macro_oil$p, h = horizon, var_order = var_order_macro_oil)
dat_irf_macro_oil <- irf_macro_oil$irf_tidy
head(dat_irf_macro_oil)
```

The next chunk of code plots the responses of the US economy to an unexpected increase in the real price of oil.
These estimates agree with those presented in figure 9.1.

```{r}
dat_plt_macro_oil <- dat_irf_macro_oil |> 
  select(horizon, ends_with("_drpoil")) |> 
  pivot_longer(starts_with("response_shock_"), names_to = "series", values_to = "response") |> 
  arrange(series, horizon) |> 
  group_by(series) |> 
  mutate(response = cumsum(response))

ggplot(data = dat_plt_macro_oil) +
  geom_line(mapping = aes(x = horizon, y = response)) +
  facet_wrap(vars(series), scales = "free")
```

This is visually close to figure 9.1 in @kilian_lutkepohl_2017.
A better reproduction requires tuning each figure separately,
which is undertaken in the code chunk below.

```{r}
plt_macro_oil_drpoil <- ggplot(data = filter(dat_plt_macro_oil, series == "response_shock_drpoil_drpoil")) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response)) +
  labs(x = "Quarters", y = "", title = "Real price of oil") +
  scale_x_continuous(breaks = seq(0, horizon, by = 5)) +
  scale_y_continuous(breaks = seq(0, 20, by = 5), limits = c(0, 20)) 
  
plt_macro_oil_infl <- ggplot(data = filter(dat_plt_macro_oil, series == "response_shock_infl_drpoil")) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response)) +
  labs(x = "Quarters", y = "", title = "GDP deflator") +
  scale_x_continuous(breaks = seq(0, horizon, by = 5)) +
  scale_y_continuous(breaks = seq(-1, 1, by = 0.5), limits = c(-1, 1)) 

plt_macro_oil_drgdp <- ggplot(data = filter(dat_plt_macro_oil, series == "response_shock_drgdp_drpoil")) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response)) +
  labs(x = "Quarters", y = "", title = "Real GDP") +
  scale_x_continuous(breaks = seq(0, horizon, by = 5)) +
  scale_y_continuous(breaks = seq(-1, 1, by = 0.5), limits = c(-1, 1)) 

plt_macro_oil_drpoil | plt_macro_oil_infl | plt_macro_oil_drgdp
```


## Empirical application: Kilian's "Not all oil price shocks are alike"

So far the codes have been used to 
estimate a VAR($p$) model and
estimate impulse responses from a structural model identified recursively.
To do inference

### Data

```{r}
p <- 24

dat_global_oil_plt <- kilianLutkepohlCh12Figure12_5 |> 
  filter(date > min(date) + lubridate::dmonths(p - 1))
  # filter(date > min(date) + base::months(p - 1))

plt_oil_production <- ggplot(data = dat_global_oil_plt) +
  geom_line(mapping = aes(x = date, y = oil_supply)) +
  labs(x = "", y = "Percent", title = "Growth rate of global oil production") +
  scale_y_continuous(breaks = seq(-10, 10, by = 5), limits = c(-10, 10)) +
  scale_x_date(expand = c(0, 0))  

plt_agg_demand <- ggplot(data = dat_global_oil_plt) +
  geom_line(mapping = aes(x = date, y = agg_demand)) +
  labs(x = "", y = "Percent", title = "Business cycle index of global real economic activity") +
  scale_y_continuous(breaks = seq(-100, 100, by = 50), limits = c(-100, 100)) +
  scale_x_date(expand = c(0, 0))

plt_rpoil <- ggplot(data = dat_global_oil_plt) +
  geom_line(mapping = aes(x = date, y = rpoil)) +
  labs(x = "", y = "Log", title = "Real price of oil") +
  scale_y_continuous(breaks = seq(-3, -0.5, by = 1), limits = c(-3, 0))  +
  scale_x_date(expand = c(0, 0))

plt_oil_production / plt_agg_demand / plt_rpoil
```
The figure is comparable to figure 12.4 in @kilian_lutkepohl_2017.

### Estimation

```{r}
y_global_oil <- kilianLutkepohlCh12Figure12_5 |> 
  # mutate(check_oil_supply = detrendcl(oil_supply, tt = "constant")) |>   
  mutate(across(c(oil_supply, agg_demand, rpoil), \(x) detrendcl(x, tt = "constant"))) |> 
  rename(oilsupply = oil_supply,
         aggdemand = agg_demand) |> 
  select(-date) |> 
  as.matrix()

horizon <- 15

sol_global_oil <- olsvarc(y_global_oil, p = 24)
var_order_global_oil <- c("oilsupply", "aggdemand", "rpoil")
var_cumsum_global_oil <- c("response_shock_oilsupply_oilsupply", 
                           "response_shock_oilsupply_aggdemand",
                           "response_shock_oilsupply_rpoil")
negative_shocks_global_oil <- c("oilsupply")

irf_global_oil <- irfvar(Ahat = sol_global_oil$Ahat, 
                        B0inv = t(chol(sol_global_oil$SIGMAhat)),
                        p = sol_global_oil$p, h = horizon, 
                        negative_shocks = negative_shocks_global_oil,
                        var_cumsum = var_cumsum_global_oil,
                        var_order = var_order_global_oil)
dat_irf_global_oil <- irf_global_oil$irf_tidy

ggplot(data = dat_irf_global_oil) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply))
```

### Inference

The code base makes computation of the confidence sets straightforward.
```{r}
nrep <- 2000
dat_irf_global_oil_ci <- bootstrap_standard(olsobj = sol_global_oil, 
                                            irfobj = irf_global_oil, 
                                            nrep = nrep, 
                                            h = horizon, 
                                            bootstrap_seed = 676, display_progress_bar = TRUE)
```

### Plotting everything

Here are the plots:

```{r}
# Negative oil-supply shock
plt_oilsupply_oilsupply <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply), color = "red") + 
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply_hi), color = "blue", linetype = "dotted") +
  labs(x = "", y = "Oil production", title = "Oil supply shock")  +
  scale_y_continuous(breaks = c(-2, -1, 0), limits = c(-2, 0.5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_aggdemand_oilsupply <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_aggdemand_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_aggdemand_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_aggdemand_oilsupply_hi), color = "blue", linetype = "dotted") +
  labs(x = "", y = "Real activity", title = "Oil supply shock") +
  scale_y_continuous(breaks = c(-5, 0, 5), limits = c(-5, 5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_oilsupply <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_hi), color = "blue", linetype = "dotted") +  
  labs(x = "", y = "Real price of oil", title = "Oil supply shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.075, 0.075)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

# Aggregate-demand shock
plt_oilsupply_aggdemand <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_oilsupply_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_oilsupply_aggdemand_hi), color = "blue", linetype = "dotted") +    
  labs(x = "", y = "Oil production", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-1, 0, 1), limits = c(-1.5, 1.0)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_aggdemand_aggdemand <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_aggdemand_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_aggdemand_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_aggdemand_aggdemand_hi), color = "blue", linetype = "dotted") +      
  labs(x = "", y = "Real activity", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(-2, 8, by = 2), limits = c(-2, 8)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_aggdemand <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_hi), color = "blue", linetype = "dotted") +        
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.05, 0.1)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

# Oil-specific demand shock
plt_oilsupply_rpoil <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_oilsupply_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_oilsupply_rpoil_hi), color = "blue", linetype = "dotted") +          
  labs(x = "Months", y = "Oil production", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = c(-1, 0, 1), limits = c(-1.5, 1.0)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_aggdemand_rpoil <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_aggdemand_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_aggdemand_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_aggdemand_rpoil_hi), color = "blue", linetype = "dotted") +   
  labs(x = "Months", y = "Real activity", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = c(-5, 0, 5), limits = c(-5, 5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_rpoil <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_ci, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_hi), color = "blue", linetype = "dotted") +              
  labs(x = "Months", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(0, 0.15, by = 0.05), limits = c(0.0, 0.15)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

(plt_oilsupply_oilsupply | plt_aggdemand_oilsupply | plt_rpoil_oilsupply) / 
  (plt_oilsupply_aggdemand | plt_aggdemand_aggdemand | plt_rpoil_aggdemand) / 
  (plt_oilsupply_rpoil | plt_aggdemand_rpoil | plt_rpoil_rpoil) &
    theme(plot.title = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          axis.text.x = element_text(size = 10))
```

### Alternative 95-percent bootstrap confidence intervals

Here are alternative ways to construct confidence intervals.

```{r}
dat_irf_global_oil_efronp <-
  bootstrap_standard(
    olsobj = sol_global_oil,
    irfobj = irf_global_oil,
    method = "efron_percentile",
    efron_percentile_quantiles = c(0.025, 0.975),
    nrep = nrep,
    bootstrap_seed = 676,
    display_progress_bar = TRUE
  )

dat_irf_global_oil_hallp <-
  bootstrap_standard(
    olsobj = sol_global_oil,
    irfobj = irf_global_oil,
    method = "hall_percentile",
    efron_percentile_quantiles = c(0.025, 0.975),
    nrep = nrep,
    bootstrap_seed = 676,
    display_progress_bar = TRUE
  )

# Equal percentile-t
dat_irf_global_oil_epct <-
  bootstrap_standard(
    olsobj = sol_global_oil,
    irfobj = irf_global_oil,
    method = "equal_percentile_t",
    nrep = 200,
    nrep_inside_boot = 100,
    bootstrap_seed = 676,
    display_progress_bar = TRUE
  )

# Symmetric percentile-t
dat_irf_global_oil_spct <-
  bootstrap_standard(
    olsobj = sol_global_oil,
    irfobj = irf_global_oil,
    method = "symmetric_percentile_t",
    nrep = 200,
    nrep_inside_boot = 75,
    bootstrap_seed = 676,
    display_progress_bar = TRUE
  )
```
Now compare confidence sets:
```{r}
# Response of real price of oil to supply shock
plt_rpoil_oilsupply_efronp <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_efronp, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_efronp, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_hi), color = "blue", linetype = "dotted") +   
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(-0.05, 0.05, by = 0.05), limits = c(-0.075, 0.075)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_oilsupply_hallp <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_hallp, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_hallp, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_hi), color = "blue", linetype = "dotted") +   
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(-0.05, 0.05, by = 0.05), limits = c(-0.075, 0.075)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_oilsupply_epct <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_epct, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_epct, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_hi), color = "blue", linetype = "dotted") +   
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(-0.05, 0.05, by = 0.05), limits = c(-0.075, 0.075)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_oilsupply_spct <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_spct, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_spct, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_hi), color = "blue", linetype = "dotted") +   
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(-0.05, 0.05, by = 0.05), limits = c(-0.075, 0.075)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

# Response of real price of oil to aggregate-demand shock
plt_rpoil_aggdemand_efronp <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_efronp, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_efronp, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_hi), color = "blue", linetype = "dotted") +     
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.05, 0.1)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_aggdemand_hallp <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_hallp, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_hallp, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_hi), color = "blue", linetype = "dotted") +     
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.05, 0.1)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_aggdemand_epct <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_epct, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_epct, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_hi), color = "blue", linetype = "dotted") +     
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.05, 0.1)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_aggdemand_spct <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_spct, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_spct, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_hi), color = "blue", linetype = "dotted") +     
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.05, 0.1)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

# Response of real price of oil to oil-specific demand shock
plt_rpoil_rpoil_efronp <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_efronp, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_efronp, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_hi), color = "blue", linetype = "dotted") +     
  labs(x = "Months", y = "Real price of oil", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = seq(0, 0.15, by = 0.05), limits = c(0.0, 0.15)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_rpoil_hallp <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_hallp, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_hallp, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_hi), color = "blue", linetype = "dotted") +   
  labs(x = "Months", y = "Real price of oil", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = seq(0, 0.15, by = 0.05), limits = c(0.0, 0.15)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_rpoil_epct <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_epct, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_epct, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_hi), color = "blue", linetype = "dotted") +   
  labs(x = "Months", y = "Real price of oil", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = seq(0, 0.15, by = 0.05), limits = c(0.0, 0.15)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_rpoil_spct <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_spct, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_spct, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_hi), color = "blue", linetype = "dotted") +   
  labs(x = "Months", y = "Real price of oil", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = seq(0, 0.15, by = 0.05), limits = c(0.0, 0.15)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

(plt_rpoil_oilsupply_efronp | plt_rpoil_oilsupply_hallp | plt_rpoil_oilsupply_epct | plt_rpoil_oilsupply_spct) / 
  (plt_rpoil_aggdemand_efronp | plt_rpoil_aggdemand_hallp | plt_rpoil_aggdemand_epct | plt_rpoil_aggdemand_spct) /
  (plt_rpoil_rpoil_efronp | plt_rpoil_rpoil_hallp | plt_rpoil_rpoil_epct | plt_rpoil_rpoil_spct) &
    theme(plot.title = element_text(size = 8),
          axis.text.y = element_text(size = 6),
          axis.text.x = element_text(size = 6),
          )
```
# Wild bootstrap

```{r}
y_global_oil <- kilianLutkepohlCh12Figure12_5 |> 
  # mutate(check_oil_supply = detrendcl(oil_supply, tt = "constant")) |>   
  mutate(across(c(oil_supply, agg_demand, rpoil), \(x) detrendcl(x, tt = "constant"))) |> 
  rename(oilsupply = oil_supply,
         aggdemand = agg_demand) |> 
  select(-date) |> 
  as.matrix()

horizon <- 15

sol_global_oil <- olsvarc(y_global_oil, p = 24)
var_order_global_oil <- c("oilsupply", "aggdemand", "rpoil")
var_cumsum_global_oil <- c("response_shock_oilsupply_oilsupply", 
                           "response_shock_oilsupply_aggdemand",
                           "response_shock_oilsupply_rpoil")
negative_shocks_global_oil <- c("oilsupply")

irf_global_oil <- irfvar(Ahat = sol_global_oil$Ahat, 
                        B0inv = t(chol(sol_global_oil$SIGMAhat)),
                        p = sol_global_oil$p, h = horizon, 
                        negative_shocks = negative_shocks_global_oil,
                        var_cumsum = var_cumsum_global_oil,
                        var_order = var_order_global_oil)

# Implement wild bootstrap
dat_irf_global_oil_wild <- bootstrap_wild(olsobj = sol_global_oil, 
                                            irfobj = irf_global_oil, 
                                            nrep = nrep, 
                                            h = horizon, 
                                            bootstrap_seed = 676, 
                                          display_progress_bar = TRUE)
```


And the plot
```{r}
# Negative oil-supply shock
plt_oilsupply_oilsupply <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply), color = "red") + 
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_oilsupply_oilsupply_hi), color = "blue", linetype = "dotted") +
  labs(x = "", y = "Oil production", title = "Oil supply shock")  +
  scale_y_continuous(breaks = c(-2, -1, 0), limits = c(-2, 0.5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_aggdemand_oilsupply <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_aggdemand_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_aggdemand_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_aggdemand_oilsupply_hi), color = "blue", linetype = "dotted") +
  labs(x = "", y = "Real activity", title = "Oil supply shock") +
  scale_y_continuous(breaks = c(-5, 0, 5), limits = c(-5, 5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_oilsupply <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_rpoil_oilsupply_hi), color = "blue", linetype = "dotted") +  
  labs(x = "", y = "Real price of oil", title = "Oil supply shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.075, 0.075)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

# Aggregate-demand shock
plt_oilsupply_aggdemand <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_oilsupply_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_oilsupply_aggdemand_hi), color = "blue", linetype = "dotted") +    
  labs(x = "", y = "Oil production", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-1, 0, 1), limits = c(-1.5, 1.0)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_aggdemand_aggdemand <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_aggdemand_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_aggdemand_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_aggdemand_aggdemand_hi), color = "blue", linetype = "dotted") +      
  labs(x = "", y = "Real activity", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(-2, 8, by = 2), limits = c(-2, 8)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_aggdemand <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_rpoil_aggdemand_hi), color = "blue", linetype = "dotted") +        
  labs(x = "", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = c(-0.05, 0, 0.05), limits = c(-0.05, 0.1)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

# Oil-specific demand shock
plt_oilsupply_rpoil <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_oilsupply_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_oilsupply_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_oilsupply_rpoil_hi), color = "blue", linetype = "dotted") +          
  labs(x = "Months", y = "Oil production", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = c(-1, 0, 1), limits = c(-1.5, 1.0)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_aggdemand_rpoil <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_aggdemand_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_aggdemand_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_aggdemand_rpoil_hi), color = "blue", linetype = "dotted") +   
  labs(x = "Months", y = "Real activity", title = "Oil-specific demand shock") +
  scale_y_continuous(breaks = c(-5, 0, 5), limits = c(-5, 5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

plt_rpoil_rpoil <- ggplot(data = dat_irf_global_oil) +
  geom_hline(yintercept = 0.0) +
  geom_line(mapping = aes(x = horizon, y = response_shock_rpoil_rpoil), color = "red") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_lo), color = "blue", linetype = "dotted") +
  geom_line(data = dat_irf_global_oil_wild, mapping = aes(x = horizon, y = response_shock_rpoil_rpoil_hi), color = "blue", linetype = "dotted") +              
  labs(x = "Months", y = "Real price of oil", title = "Aggregate demand shock") +
  scale_y_continuous(breaks = seq(0, 0.15, by = 0.05), limits = c(0.0, 0.15)) +
  scale_x_continuous(breaks = seq(0, 15, by = 5), expand = c(0, 0))

(plt_oilsupply_oilsupply | plt_aggdemand_oilsupply | plt_rpoil_oilsupply) / 
  (plt_oilsupply_aggdemand | plt_aggdemand_aggdemand | plt_rpoil_aggdemand) / 
  (plt_oilsupply_rpoil | plt_aggdemand_rpoil | plt_rpoil_rpoil) &
    theme(plot.title = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          axis.text.x = element_text(size = 10))
```




# TOFILE

```{r}
nrep <- 20
dat_irf_global_oil_cs_1 <- bootstrap_standard(olsobj = sol_global_oil, irfobj = irf_global_oil, h = horizon, bootstrap_seed = 676, nrep = nrep)
dat_irf_global_oil_cs_2 <- bootstrap_standard(olsobj = sol_global_oil, irfobj = irf_global_oil, h = horizon, bootstrap_seed = 676, nrep = nrep)

all.equal(dat_irf_global_oil_cs_1, dat_irf_global_oil_cs_2)
```


The confidence sets can be estimated many ways.
```{r}
# Create data to look through
yview <- kilianLutkepohlCh12Figure12_5 |> 
  mutate(date_prefix = paste0(year(date), "-", format(date, "%m")),
         oil_supply = paste0(date_prefix, "-", "oilsupply"),
         agg_demand = paste0(date_prefix, "-", "aggdemand"),
         rpoil = paste0(date_prefix, "-", "rpoil")) |> 
  select(oil_supply, agg_demand, rpoil)


T_yview <- nrow(yview)
p_yview <- 3

y <- t(yview)
Y <- y[, 3:T_yview]
print(Y[, 1:3])
```

and

```{r}
print(Y[,(T_yview - p_yview - 3):(T_yview - p_yview + 1)])
```


```{r}
for (i in 1:(p_yview - 1)) {
  Y <- rbind(Y, y[, (p_yview - i):(tt - i), drop = FALSE])
}
print(Y[, 1:3])
```
And 
```{r}
print(Y[, (T_yview - p_yview + 1 - 3):(T_yview - p_yview + 1)])
```
This uses the capital-$Y$ notation.

The model
$$
y_t = \nu + A_1 y_{t-1} + \cdots + A_p y_{t-p} +u_t
$$
can be written as a VAR($1$) process by "stacking $p$ consecutive $y_t$ variables in a $pK$-dimensional vector" (*Structural Vector Autoregressive Analysis*, page 25)
$$
Y_t \equiv \left( y_t^{\prime}, \dots, y_{t-p+1}^{\prime}\right)
$$
(each $y_t$ is $\left( y_{1t},\dots,y_{Kt}\right)^{\prime}$ is $K$-dimensional and there are 
$\left(t + 1\right) - \left( t-p+1\right) = p$ vectors being stacked).
So that
$$
Y_t = \mathbf{\nu}  + \mathbf{A} Y_{t-1} + U_t,
$$
where
$$
\mathbf{\nu} \equiv \begin{bmatrix} \nu \\ 0 \\ \vdots \\ 0 \end{bmatrix}, \quad
\mathbf{A}   \equiv \begin{bmatrix} A_1 & A_2 & \cdots & A_{p-1} & A_p \\
                                    I_K & 0   & \cdots & 0       & 0   \\
                                    0   & I_K &        & 0       & 0   \\
                                    \vdots & & \ddots  & \vdots & \vdots \\
                                    0 & 0 & \cdots & I_K & 0 \end{bmatrix}, \quad
U_t \equiv \begin{bmatrix} u_t \\ 0 \\ \vdots \\ 0 \end{bmatrix}
$$
and 

* the vector $\mathbf{\nu}$ is $Kp \times 1$, 
* the matrix $\mathbf{A}$ is $Kp \times Kp$, and
* the vector $U_t$ is $Kp \times 1$.

Each column of `Y` now contains a possible initial condition.
Now the code will draw $u_1^{*r}$ and 
recursively generate, *for each bootstrap replication $r=1,\dots,R$,
a replication dataset
$$
\begin{align*}
y_1^{*r} &= \widehat{\nu} + \widehat{A}_1 y_0^{*r} + \cdots + \widehat{A}_p y_{-p+1}^{*r} + u_1^{*r} \\
y_2^{*r} &= \widehat{\nu} + \widehat{A}_1 y_1^{*r} + \cdots + \widehat{A}_p y_{-p+2}^{*r} + u_2^{*r} \\
\vdots   &\quad \vdots \\
y_T^{*r} &=  \widehat{\nu} + \widehat{A}_1 y_{T-1}^{*r}  + \cdots + \widehat{A}_p y_{T-p}^{*r} + u_T^{*r} 
\end{align*}
$$

Or
$$
Y_t^{*r} = \widehat{\nu} + \widehat{\mathbf{A}} Y_{t-1}^{*r} + U_t^{*r}
$$

### OLD Inference

For the developing structural model,

```{r}
y_global_oil <- kilianLutkepohlCh12Figure12_5 |> 
  # mutate(check_oil_supply = detrendcl(oil_supply, tt = "constant")) |>   
  mutate(across(c(oil_supply, agg_demand, rpoil), \(x) detrendcl(x, tt = "constant"))) |> 
  rename(oilsupply = oil_supply,
         aggdemand = agg_demand) |> 
  select(-date) |> 
  as.matrix()


tt <- nrow(y_global_oil)
pp <- 24
KK <- ncol(y_global_oil)

# Another way to construct Y
y_slow <- t(y_global_oil)
Y_slow <- y_slow[, pp:tt]

for (i in 1:(pp - 1)) {
  Y_slow <- rbind(Y_slow, y_slow[, (pp - i):(tt - i), drop = FALSE])
}

benchmarkY <- function(y) {
  y <- t(y)
  Y <- y[, pp:tt]
  for (i in 1:(pp - 1)) {
    Y <- rbind(Y, y[, (pp - i):(tt - i), drop = FALSE])
  }
  Y
}

benchmarkSol <- function(sol) {
  Zt <- sol$Z[2:(KK * pp + 1),]
  Y <- rbind(sol$Y[, tt - pp, drop = FALSE], Zt[1:(KK * pp - KK), tt - pp, drop = FALSE])
  Y <- cbind(Zt, Y)
  Y
}


(lb <- bench::mark(
  benchmarkY(y_global_oil),
  benchmarkSol(sol_global_oil)
))

Zt <- sol_global_oil$Z[2:(KK * pp + 1),]

Ytt <- rbind(sol_global_oil$Y[, tt - pp, drop = FALSE], Zt[1:(KK * pp - KK), tt - pp, drop = FALSE])
Y <- cbind(Zt, Ytt)

stopifnot(near(Y, Y_slow))

vars_cumsum <- c("response_shock_oilsupply_oilsupply", 
                 "response_shock_oilsupply_aggdemand",
                 "response_shock_oilsupply_rpoil")

KK <- 3
IK <- diag((pp - 1) * KK)
AP0 <- matrix(0, nrow = ((pp - 1) * KK), ncol = KK)
A <- rbind(sol_global_oil$Ahat, cbind(IK, AP0))

NU <- rbind(sol_global_oil$Vhat, matrix(0, nrow = KK * pp - KK, ncol = 1))


U <- sol_global_oil$Uhat # dimension K x (tt - pp), tt is the number of data and pp is the VAR length

nrep <- 2000

mIRF <- matrix(1, nrow = nrep, ncol = (KK^2) * (horizon + 1))

for (r in 1:nrep) {
  print(paste0("Bootstrap replication...", r))
  
  rY <- matrix(NA, KK * pp, tt - pp + 1) 
  rU <- matrix(0, KK * pp, tt - pp)   
  rydat <- matrix(NA, tt - pp, KK)  
  
  # Initial condition
  rpos_y0 <- floor(runif(1, min = 0, max = 1) * (tt - pp + 1)) + 1
  rY0 <- Y[, rpos_y0, drop = FALSE]
  rY[1:(KK * pp), 1] <- rY0
  
  # iid resampling
  riid_index <- floor(runif(tt - pp, min = 0, max = 1) * (tt - pp)) + 1
  # print(riid_index)
  rU[1:KK, 1:(tt - pp)] <- U[, riid_index] 
  
  # rY1 <- NU + A %*% rY0 + rU[1:(KK * pp), 1, drop = FALSE]
  # rY2 <- NU + A %*% rY1 + rU[1:(KK * pp), 2, drop = FALSE]
  # rY3 <- NU + A %*% rY2 + rU[1:(KK * pp), 3, drop = FALSE]
  
  # rY[1:(KK * pp), 1] <- NU + A %*% rY0 + rU[1:(KK * pp), 1, drop = FALSE]
  # rY[1:(KK * pp), 1] <- sol_global_oil$Vhat + sol_global_oil$Ahat %*% rY0 + rU[1:(KK * pp), 1, drop = FALSE]
  
  for (i in 2:(tt - pp + 1)) {
    rY[1:(KK * pp), i] <- NU + A %*% rY[1:(KK * pp), i - 1, drop = FALSE] + rU[1:(KK * pp), i - 1, drop = FALSE]
    rydat[i - 1, 1:KK] <- rY[1:KK, i]
  }
  
  # Concatenate the initial vector to rydat
  rY0_wide <- matrix(rY0, nrow = pp, ncol = KK, byrow = TRUE)
  rydat <- rbind(rY0_wide, rydat)
  stopifnot(nrow(rydat) == tt)
  
  
  rsol <- olsvarc(rydat, p = pp)
  rB0inv <- t(chol(rsol$SIGMAhat))
  rIRF <- irfvar(rsol$Ahat, rB0inv, p = pp, h = horizon, var_order = var_order_global_oil, return_tidy = FALSE)
  
  for (v in vars_cumsum) {
    rIRF[v, ] <- cumsum(rIRF[v, ])
  }
  
  mIRF[r, ] <- matrix(rIRF, nrow = 1)
}

IRF <- irfvar(Ahat = sol_global_oil$Ahat, 
                             B0inv = t(chol(sol_global_oil$SIGMAhat)),
                             p = sol_global_oil$p, h = horizon, var_order = var_order_global_oil,
              return_tidy = FALSE)

negative_shocks <- c("oilsupply", "aggdemand")
my_rownames <- rownames(IRF)

negative_shocks_to_adjust <- vector(mode = "character")
for (ns in negative_shocks) {
  ns_adj <- my_rownames[stringr::str_detect(my_rownames, paste0("_", ns, "$"))]
  negative_shocks_to_adjust <- c(negative_shocks_to_adjust, ns_adj)
}

for (ns in negative_shocks_to_adjust) {
  IRF[ns, ] <- -IRF[ns, ]
}


# negative_shocks_to_adjust <- my_rownames[stringr::str_detect(my_rownames, "_oilsupply$")]

for (v in vars_cumsum) {
  IRF[v, ] <- cumsum(IRF[v, ])
  }

# IRF["response_shock_oilsupply_oilsupply", ] <- -IRF["response_shock_oilsupply_oilsupply", ]
# IRF["response_shock_aggdemand_oilsupply", ] <- -IRF["response_shock_aggdemand_oilsupply", ]
# IRF["response_shock_rpoil_oilsupply", ] <- -IRF["response_shock_rpoil_oilsupply", ]

mIRFstd <- matrix(apply(mIRF, 2, sd), nrow = KK^2, ncol = horizon + 1)

mCIlo <- IRF - 2 * mIRFstd
mCIhi <- IRF + 2 * mIRFstd

rownames(mCIlo) <- paste0(get_irf_names(var_order_global_oil), "_lo")
rownames(mCIhi) <- paste0(get_irf_names(var_order_global_oil), "_hi")

dat_CIlo <- as_tibble(t(mCIlo)) |> 
  mutate(horizon = 0:horizon)

dat_CIhi <- as_tibble(t(mCIhi)) |> 
  mutate(horizon = 0:horizon)

dat_CI <- dat_CIlo |> 
  left_join(dat_CIhi, by = join_by(horizon))

# dat_IRFstd <- dat_IRFstd |>
#   mutate(horizon = 0:horizon) |>
#   select(horizon, everything())

# CIlo <- IRF - 2 * mIRFstd
# CIhi <- IRF + 2 * mIRFstd
```

# References


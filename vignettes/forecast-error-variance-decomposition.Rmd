---
title: "forecast-error-variance-decomposition"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{forecast-error-variance-decomposition}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction to computing a forecast error variance decomposition

A structural VAR model
allows us to answer how much of the forecast error variance
of $y_{t+h}$ at horizon $h=0,1,\dots,H$ is accounted for by each structural shock, $k=1,\dots,K$.
Sometimes the forecast error variance is referred to as the prediction mean-squared error.
In a stationary model,
as $h\rightarrow \infty$,
the limit of the forecast error variance decomposition is the variance decomposition of $y_t$.

```{r setup}
library(kilianr)
library(patchwork) # for combining plots

var_order_stock_market <- c("dprod", "rea", "rpoil", "dd")
y_stock_market <- kilianLutkepohlCh04Table4_1 |> select(all_of(var_order_stock_market))
sol_stock_market <- olsvarc(y_stock_market, p = 24)
```

The following reproduces figure 4.1 in KL:
```{r}
horizon <- 15
irf_stock_market <- irfvar(sol_stock_market$Ahat, B0inv = t(chol(sol_stock_market$SIGMAhat)), 
                           p = sol_stock_market$p, h = horizon, var_order = var_order_stock_market,
                           negative_shocks = c("dprod"),
                           var_cumsum = c("response_shock_dd_dprod", "response_shock_dd_rea", "response_shock_dd_rpoil"))
dat_irf_stock_market <- irf_stock_market$irf_tidy
head(dat_irf_stock_market)
```

```{r}
plt_oil_supply <- ggplot(data = dat_irf_stock_market) +
  geom_line(mapping = aes(x = horizon, y = response_shock_dd_dprod)) +
  geom_hline(yintercept = 0) + labs(title = "Oil supply shock") +
  xlab("Months") + ylab("Real dividends (percent)") +
  ylim(-2, 2)

plt_aggdemand <- ggplot(data = dat_irf_stock_market) +
  geom_line(mapping = aes(x = horizon, y = response_shock_dd_rea)) +
  geom_hline(yintercept = 0) + labs(title = "Aggregate demand shock") +
  xlab("Months") + ylab("Real dividends (percent)") +
  ylim(-2, 2)

plt_price_oil <- ggplot(data = dat_irf_stock_market) +
  geom_line(mapping = aes(x = horizon, y = response_shock_dd_rpoil)) +
  geom_hline(yintercept = 0) + labs(title = "Oil-specific demand shock") +
  xlab("Months") + ylab("Real dividends (percent)") +
  ylim(-2, 2)

plt_oil_supply + plt_aggdemand + plt_price_oil
```

The forecast error variance decomposition 
```{r}
# Create dataset at different horizons
dat_fevd <- tribble(
  ~Horizon,
  1,
  2,
  3,
  12,
  600
)

# Compute the forecast error variance decompositions
dat_fevd <- dat_fevd |> 
  mutate(percent_explained = map(Horizon, \(x) as_tibble(compute_fcast_error_var_decomp(h = x, solvar = sol_stock_market, var_name = "dd"))))

dat_fevd <- dat_fevd |> 
  unnest(percent_explained) |> 
  rename(`Oil supply shock` = dprod,
         `Aggregate demand shock` = rea,
         `Oil-specific demand shcok` = rpoil,
         `Residual shock` = dd)

knitr::kable(round(dat_fevd, 1))
```

It is also possible to let $h \rightarrow \infty$.
The function `compute_fcast_error_var_decomp()` can accept `Inf`,
which will increase the horizon ($h$) until the 
percent of $h$-step ahead forecast error variance explained by the
structural shocks converges.
```{r}
check_Inf <- compute_fcast_error_var_decomp(solvar = sol_stock_market, h = Inf, var_name = "dd", eps = 1e-3)
```

The percentage explained is within tolerance at horizon `r check_Inf$horizon`.

```{r}
ggplot(data = check_Inf) +
  geom_line(mapping = aes(x = horizon, y = dd)) +
  geom_line(mapping = aes(x = horizon, y = dprod), color = "red") +
  geom_line(mapping = aes(x = horizon, y = rea), color = "green") +  
  geom_line(mapping = aes(x = horizon, y = rpoil), color = "blue") 
```

